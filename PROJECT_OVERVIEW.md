# Calcshark — Project Overview (Quick Onboarding Guide)

This document gives you a fast, practical understanding of the Calcshark codebase so you can be productive in minutes. It covers architecture, routing, data flow, calculators, SEO, security, sitemap, scripts, and common workflows.

Last updated: [auto-generated by Rovo Dev]


## 1) Tech Stack & Core Concepts
- Framework: Next.js 14 (App Router)
- Language: TypeScript, React 18
- Styling: Tailwind CSS, tailwindcss-animate, global CSS tokens in `app/globals.css`
- State/UI libs: react-hook-form, framer-motion, lucide-react, zustand (not widely used in core pages)
- Charts: bespoke TSX chart components (no heavy chart library)
- Data validation: zod (light usage)
- Build: Node + npm; production source maps disabled; console stripped in prod
- Security: Strict CSP + robust headers + middleware hardening


## 2) High-level Architecture
- App Router structure under `app/` with both:
  - Nested canonical routes: `/{category}/{subcategory}/{calculator}/`
  - Legacy routes (kept for compatibility): `/calculator/[slug]`
- Calculator metadata (735+ items) stored in `lib/calculator-categories.ts` (auto-generated from `calculator_list.txt` via scripts)
- Actual calculator TSX implementations live in:
  - Canonical path: `app/[category]/[subcategory]/[calculator]/calculators/`
  - Legacy path: `app/calculator/[slug]/calculators/`
- Dynamic sitemap is generated from real, existing pages (filesystem discovery) at runtime
- Strong SEO defaults + structured data at both global and per-page levels
- Security middleware adds headers, rate limiting, and request filtering


## 3) Key Directories (What’s where)
- `app/`
  - `layout.tsx` — global layout, loads Header/Footer, global schemas, default SEO
  - `page.tsx` — homepage (client component with search and curated content)
  - `all-online-calculators/` — full list page with live search
  - `categories/` — overview of categories
  - `popular/` — curated popular calculators
  - `[category]/` — dynamic category page (lists subcategories)
  - `[category]/[subcategory]/` — dynamic subcategory page (lists calculators)
  - `[category]/[subcategory]/[calculator]/` — dynamic calculator page shell
    - `components/CalculatorLayout.tsx` — shared layout for calculator pages
    - `calculators/*.tsx` — actual implementations (e.g. AdvancedMortgageCalculator)
  - `calculator/[slug]/` — legacy single-level route for calculators (kept for compatibility)
  - `sitemap.xml/route.ts` — dynamic sitemap endpoint
  - `sitemap-index.xml/route.ts` — sitemap index
- `components/`
  - `layout/header.tsx`, `layout/footer.tsx` — site chrome
  - `ui/` — reusable UI: Card, FAQAccordion, charts, scroll-to-top
- `lib/`
  - `calculator-categories.ts` — main structured data for categories/subcategories/calculators (auto-generated)
  - `calculator-data-generated.ts` — additional generated data (unused in core routing)
  - `route-discovery.ts` — discovers real pages for the dynamic sitemap
  - `seo.ts` — default SEO + calculator-specific SEO map + metadata helpers
  - `schemas.ts` — structured data (Organization, Website, SoftwareApplication, Breadcrumb)
  - `security.ts` — sanitization, validation, rate limiter, HSTS config, secure headers
  - `utils.ts` — helpers (`cn`, `formatNumber`, `slugify`)
- `scripts/`
  - `parse-calculators.js` — builds `lib/calculator-categories.ts` from `calculator_list.txt`
  - `generate-sitemap.js` — optional static sitemap generator (not used in runtime)
  - `test-sitemap-discovery.js` — diagnostics for route discovery
  - `analyze-data.js`, `analyze-html.js`, `count-original.js` — diagnostics and reporting
- `public/`
  - `robots.txt`, `manifest.json`, favicons


## 4) Routing & URL Strategy
- Canonical user-facing URLs use trailing slashes and 3-level nesting:
  - Category: `/{category}/`
  - Subcategory: `/{category}/{subcategory}/`
  - Calculator: `/{category}/{subcategory}/{calculator}/`
- Legacy `/calculator/[slug]` is still served:
  - Some old slugs are redirected by `middleware.ts` to the new nested paths
  - The legacy folder also implements a subset of calculators for backward compatibility
- Trailing slash behavior is enforced by Next config (`trailingSlash: true`)


## 5) Data Model (lib/calculator-categories.ts)
- A large, auto-generated array describing:
  - Categories: `{ name, slug, description, subcategories: [...] }`
  - Subcategories: `{ name, slug, description, calculators: [...] }`
  - Calculators: `{ name, slug, description, tags, difficulty, popular, ... }`
- Helper functions (in the generated file) are used by pages:
  - `getCategoryBySlug`, `getSubcategoryBySlug`, `getCalculatorByNestedSlug`, `getCalculatorBySlug`, `getCalculatorURL`, etc.
- Source of truth for content structure


## 6) Calculator Pages — How They Render
- Page shells:
  - Canonical: `app/[category]/[subcategory]/[calculator]/page.tsx`
  - Legacy: `app/calculator/[slug]/page.tsx`
- Each page resolves metadata via `lib/seo.ts` and structured data via `lib/schemas.ts`
- A local `calculatorComponents` map determines which TSX implementation to render (by slug)
  - Example (canonical):
    ```ts
    const calculatorComponents = {
      'bmi-calculator': AdvancedBMICalculator,
      'basic-bmi-calculator': BMICalculator,
      'compound-interest-calculator': AdvancedCompoundInterestCalculator,
      'mortgage-payment-calculator': AdvancedMortgageCalculator,
      'loan-payment-calculator': AdvancedLoanPaymentCalculator,
    };
    ```
  - If a slug exists in data but no component is mapped, a "Coming Soon" message is rendered


## 7) Adding or Updating a Calculator (Step-by-step)
1) Update data (optional, if new calculator):
   - Preferred: edit `calculator_list.txt` then run `node scripts/parse-calculators.js` to regenerate `lib/calculator-categories.ts`
   - Alternatively: directly edit `lib/calculator-categories.ts` (not recommended; generated file)
2) Implement the calculator component:
   - Create `app/[category]/[subcategory]/[calculator]/calculators/YourCalculator.tsx`
   - Use an existing advanced calculator as a template (e.g., `AdvancedLoanPaymentCalculator.tsx`)
3) Wire the component in the page shell:
   - Import the new component inside `app/[category]/[subcategory]/[calculator]/page.tsx`
   - Add an entry to the `calculatorComponents` map keyed by the exact calculator slug from data
4) Verify routing and sitemap:
   - Run dev server, visit `/{category}/{subcategory}/{calculator}/`
   - Check `GET /sitemap.xml` includes the new route (it only includes calculators that have a component file present)


## 8) Search & Discovery
- Search UX appears in:
  - Homepage hero
  - Header (desktop dropdown) and mobile menu
  - All calculators page (`/all-online-calculators`) with URL param `?search=`
- See `scripts/test-search.js` for a manual test checklist of search behavior and link fixes


## 9) SEO & Structured Data
- Global defaults from `lib/seo.ts` applied in `app/layout.tsx`
- Per-page metadata via `generateMetadata(...)` in page shells (categories, subcategories, calculators)
- Open Graph and Twitter cards are configured (uses prebuilt OG image URLs)
- Structured data generators in `lib/schemas.ts`:
  - Organization, Website, BreadcrumbList, SoftwareApplication
- `next.config.js` sets security headers including CSP; inline scripts for schemas come via `dangerouslySetInnerHTML` (kept minimal in head)


## 10) Security & Middleware
- `next.config.js` headers:
  - CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy, HSTS (env-aware)
- `middleware.ts`:
  - URL redirects from old slugs to nested URLs
  - API rate limiting by IP (defaults: 100 req / 15 min)
  - Additional headers (X-Robots-Tag, etc.) and HSTS via `lib/security.ts`
  - Blocks suspicious user agents and sensitive paths (`/.env`, `/admin`, etc.)
  - Validates Content-Type for POST requests
- `lib/security.ts`:
  - `sanitizeInput`, `validateEmail`, `validateURL`
  - `validateCalculatorInput` (bounded numeric parsing)
  - secure localStorage wrapper
  - HSTS helpers and `secureHeaders` for APIs
  - CSRF helpers (nonce-based)
- See `SECURITY.md` for a comprehensive policy and checklists


## 11) Dynamic Sitemap & robots.txt
- Dynamic endpoint: `app/sitemap.xml/route.ts`
  - Discovers real pages via `lib/route-discovery.ts`
  - Caches results for 5 minutes
  - Prioritizes Homepage, Popular, Categories; calculators monthly
- Index endpoint: `app/sitemap-index.xml/route.ts`
- robots.txt: allows broad crawling; blocks sensitive folders; points to `/sitemap.xml`
- Static generator script available (optional): `scripts/generate-sitemap.js`
- See `SITEMAP.md` for detailed behavior and usage


## 12) UI Building Blocks
- `components/ui/card.tsx` — Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter
- `components/ui/faq-accordion.tsx` — accessible accordion with categories
- Charts:
  - `components/ui/bmi-charts.tsx`
  - `components/ui/compound-interest-charts.tsx`
  - `components/ui/mortgage-charts.tsx`
- Global styles & tokens: `app/globals.css` (includes dark theme variables and utilities)


## 13) Config & Build
- `package.json` scripts:
  - Dev: `npm run dev`
  - Build: `npm run build`; Start: `npm start`
  - Lint: `npm run lint`
  - Security: `npm run security:audit`, `npm run security:hsts`
  - HTML checks: `npm run html:analyze`, `npm run html:check`
  - Sitemap: `npm run sitemap:generate`, `npm run sitemap:test`, `npm run sitemap:discover`
  - Search test: `npm run test:search`
- `tsconfig.json` uses Next.js plugin, path alias `@/*` => project root
- `tailwind.config.js` watches pages/components/app; custom theme tokens


## 14) Common Tasks (Runbook)
- Start dev server:
  ```bash
  npm install
  npm run dev
  ```
- Add a new calculator:
  - Update data via generator, add component, wire in `calculatorComponents`, verify in browser and sitemap
- Change SEO for a specific calculator:
  - Update the `calculatorSEO` map in `lib/seo.ts` (then check OG/Twitter)
- Adjust CSP or security headers:
  - Edit `next.config.js` (keep in sync with `middleware.ts` behavior)
- Test sitemap discovery locally:
  ```bash
  node scripts/test-sitemap-discovery.js
  ```


## 15) Gotchas & Conventions
- Trailing slashes: URLs and sitemap include trailing `/` — keep consistent
- Two calculator systems exist (legacy vs canonical): prefer canonical 3-level routes; keep legacy until fully migrated
- Dynamic sitemap only includes calculators that have a real TSX component file in canonical path
- Large auto-generated files: do not hand-edit `lib/calculator-categories.ts` — regenerate instead
- Use `lib/security.ts` helpers for any new inputs; sanitize and bound numeric inputs


## 16) Future Enhancements (Suggestions)
- Finish migration from `/calculator/[slug]` to nested canonical routes and unify sitemap/links
- Centralize calculator component registry to avoid duplicating the `calculatorComponents` map across routes
- Consider lazy-loading heavy charts to improve TTI
- Add unit tests around `lib/route-discovery.ts` and security helpers


## 17) Quick File Index (Frequently Touched)
- Layout & SEO
  - `app/layout.tsx`, `lib/seo.ts`, `lib/schemas.ts`
- Core pages
  - `app/page.tsx`, `app/all-online-calculators/page.tsx`, `app/categories/page.tsx`, `app/popular/page.tsx`
- Dynamic routes
  - `app/[category]/page.tsx`, `app/[category]/[subcategory]/page.tsx`, `app/[category]/[subcategory]/[calculator]/page.tsx`
- Calculators (canonical)
  - `app/[category]/[subcategory]/[calculator]/calculators/*`
- Data & discovery
  - `lib/calculator-categories.ts`, `lib/route-discovery.ts`
- Security
  - `next.config.js`, `middleware.ts`, `lib/security.ts`


## 18) Open TODOs
- No explicit TODOs found in source (excluding `.next` artifacts). Use the "Future Enhancements" above as backlog candidates.


— End of Overview —
